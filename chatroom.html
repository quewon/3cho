<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style media="screen">
      @import url('https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css');
      @import url('https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css');
.spoka * { font-family: 'Spoqa Han Sans', 'Spoqa Han Sans JP', 'Sans-serif'; }

      :root {
        --input-height: 2em;
        --red: #d14141;
      }

      body, html {
        margin: 0;
        overflow: hidden;
        font-size: 30px;
        font-family: 'Spoqa Han Sans', sans-serif;
        /* font-smooth: never;
        -webkit-font-smoothing: none;
        -moz-osx-font-smoothing: grayscale; */
        background: var(--red);
      }

      main {
        width: 100vw;
        height: calc(100dvh - var(--input-height) - .5em);
        overflow-x: hidden;
        overflow-y: scroll;

        display: flex;
        flex-direction: column-reverse;
        align-items: baseline;
        gap: .5em;
        padding: .5em;
        box-sizing: border-box;
        background: white;
      }
      a {
        color: var(--red);
        cursor: pointer;
      }
      a.found {
        color: gray;
      }

      .response {
        animation: popup 400ms;
        transform-origin: left;
        display: flex;
        gap: .25rem;
      }
      @keyframes popup {
        0% {
          max-height: 0;
          scale: .8 1;
          margin-bottom: 0;
          opacity: 0;
        }
        50% {
          margin-bottom: 10px;
          opacity: 1;
        }
        100% {
          max-height: 100%;
          scale: 1 1;
          margin-bottom: 0;
        }
      }
      .response .icon {
        width: 2em;
        height: 2em;
        border-radius: 50%;
        background: lightgray;
        aspect-ratio: 1;
      }
      .response .content {
        padding: .5em;
        background: lightgray;
        border-radius: 1em;
      }

      .response.right {
        align-self: end;
        transform-origin: right;
      }
      .response.right .icon {
        display: none;
      }
      .response.right .content, .response.player .content {
        background: var(--red);
        color: white;
      }
      .response.right a, .response.player a {
        background: white;
      }
      .response.right:has(a) .content, .response.player:has(a) .content {
        background: white;
        border: 1px solid var(--red);
        box-sizing: border-box;
        color: black;
      }
      .response.player .icon {
        background: var(--red);
      }

      .response.date {
        font-size: .8em;
        color: white;
        opacity: .8;
        align-self: center;
        animation: none;
        color: black;
      }
      .response.date .icon {
        display: none;
      }

      #inputContainer {
        width: calc(100vw - .5em);
        height: var(--input-height);
        display: flex;
        justify-content: space-between;
        /* border: 1px solid black; */
        border-radius: 1em;
        margin: .25em;
        background: white;
        overflow: hidden;
      }
      #inputContainer button {
        /* border: 1px solid black; */
        background: var(--red);
        color: white;
        border-radius: 50%;
        width: var(--input-height);
        margin: .1rem;
      }

      input {
        width: 100vw;
        font-family: inherit;
        font-size: inherit;
        padding: .5em;
        margin: 0;
        outline: none;
        border: none;
        background: transparent;
      }
      input:disabled {
        background: lightgray;
      }
      input:disabled::placeholder {
        text-align: center;
      }
      #inputContainer:has(input:disabled) {
        background: lightgray;
      }

      .gone {
        display: none;
      }

      #start-menu {
        width: 100vw;
        height: 101dvh;
        background: var(--red);
        color: white;
        position: absolute;
        top: 0;
        left: 0;
        font-size: 20px;
      }
      #start-menu > div {
        top: 50%;
        left: 50%;
        position: absolute;
        translate: -50% -50%;
        width: 100%;
        text-align: center;
      }
      button {
        background: transparent;
        border: none;
        color: black;
        padding: .5em;
        padding-top: 0em;
        padding-bottom: 0em;
        font-size: inherit;
        font-family: inherit;
      }
      button:hover {
        cursor: pointer;
        opacity: .9
      }
      button:active {
        background: black;
        color: white;
      }

      #start-menu button {
        border: 1px solid white;
        color: white;
      }
      #start-menu button:active {
        background: white;
        color: var(--red);
      }
    </style>
  </head>
  <body>

    <main>

    </main>

    <div id="inputContainer">
      <input type="text" autofocus placeholder="키워드를 쳐보세요" />
      <button onclick="sendMessage()">></button>
    </div>

    <div id="start-menu">
      <div>
        17세기 소년을 죽이는 법
        <br><br>
        <button onclick="start()">시작</button>
      </div>
    </div>

    <template id="template-텍스트">

    </template>

  </body>
  <script defer type="text/javascript">
    const API_KEY = "AIzaSyCF5muJe5QsZnMSwjmFzofH5b3Ay-GgccY";
    const SHEET_ID = "1bIV3VUzn55cLkD-dxWoOkbt4NrA0V4OdYP_TGijlL2I";
    var BANK = {};

    function load_bank(onload) {
      function SheetArrayToObject(array) {
        if (array == undefined) return undefined;

        const keys = array[0];
        const output = [];

        for (let row=1; row<array.length; row++) {
          var entry = {};
          var inputArray = array[row][0].split(",");

          if (array[row].length==1) continue;

          for (let inputKey of inputArray) {
            output[inputKey] = {
              messages: array[row][1].split("\n"),
              rowId: row,
              color: array[row].length <= 2 ? true : array[row][2]
            };
          }
        }

        return output;
      }

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/output/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        BANK = SheetArrayToObject(data.values);
        if (onload) onload();
      });
    }

    const startMenu = document.getElementById("start-menu");
    const main = document.querySelector("main");
    const input = document.querySelector("input");

    function receiveMessage(response) {
      var element = document.createElement("div");
      element.classList.add("response");
      element.classList.add(response["형식"]);
      element.textContent = response["출력"];
      main.appendChild(element);
    }

    var keywordsFound;
    const delay = ms => new Promise(res => setTimeout(res, ms));
    async function sendMessage() {
      if (input.disabled) return;

      const message = input.value.trim();
      if (message == "") return;

      new Message("right", message);
      write_data(message);

      input.value = "";

      await playResponses(message);
    }

    async function playResponses(message) {
      input.blur();
      input.disabled = true;
      input.placeholder = "...";

      var matchedIds = [];
      var messages = [];

      for (let key in BANK) {
        if (message.includes(key)) {
          if (!keywordsFound.includes(key)) {
            keywordsFound.push(key);
          } else {
            continue;
          }
          if (matchedIds.includes(BANK[key].rowId)) continue;
          matchedIds.push(BANK[key].rowId);
          for (let response of BANK[key].messages) {
            messages.push(response);
          }
        }
      }

      if (messages.length > 0) {
        await delay(messages[0].replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 50);
      }
      for (let i=0; i<messages.length; i++) {
        new Message("left", messages[i]);
        if (i<messages.length-1) {
          await delay(messages[i].replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 100);
        }
      }

      input.placeholder = "키워드를 쳐보세요";
      input.disabled = false;
      input.focus();
    }

    class Message {
      constructor(position, text, type) {
        var element = document.createElement("div");
        element.classList.add("response");
        if (type) element.classList.add(type);
        element.classList.add(position);

        var icon = document.createElement("div");
        icon.classList.add("icon");
        element.appendChild(icon);

        var content = document.createElement("div");
        content.classList.add("content");
        element.appendChild(content);

        for (let key in BANK) {
          if (BANK[key].color == "FALSE") continue;
          text = text.replaceAll(key, "<a class='"+(keywordsFound.includes(key) ? "found" : "")+"' onclick=input.value='"+key+"';input.focus()>"+key+"</a>")
        }
        if (text.includes(": ")) {
          text = text.split(": ")[1];
        }
        content.innerHTML = text;

        this.element = element;

        main.prepend(this.element);

        main.scrollTop = main.scrollHeight;
        element.onanimationend = function() {
          main.scrollTop = main.scrollHeight;
        };
      }
    }

    load_bank(function() {
      input.addEventListener("keyup", function(e) {
        if (e.key == "Enter") {
          sendMessage();
        }
      });
      // input.onblur = function() {
      //   this.focus();
      // };
    });

    function read_data() {
      const timestamp = new Date().getTime();

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/history/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        if (chatOpen) setTimeout(read_data, 2000);

        if (input.disabled) return;

        for (let i=1; i<data.values.length; i++) {
          const messageTimestamp = data.values[i][0];
          const messageContent = data.values[i][1];

          if (
            messageTimestamp >= startTimestamp &&
            (
              !loggedMessages[messageTimestamp] || loggedMessages[messageTimestamp] != messageContent
            )
          ) {
            loggedMessages[messageTimestamp] = messageContent;
            new Message("left", messageContent, "player");
            playResponses(messageContent);
          }
        }
      });
    }

    function write_data(text) {
      const timestamp = new Date().getTime();
      const data = new FormData();
      data.set("timestamp", timestamp);
      data.set("text", text);

      loggedMessages[timestamp] = text;

      fetch("https://script.google.com/macros/s/AKfycbzYX6v5YFLqdMqhaAt61C6epn6emf5SY2YFU4_ILEJv3EiRmsjPo_NbfJ4Qdt4yAI3G/exec", {
        method: "POST",
        body: data
      })
      .then(function(e) {
        console.log("success")
      })
      .catch(function(e) {
        console.log("** error **\n"+e);
      });
    }

    var startTimestamp;
    var loggedMessages = {};
    var chatOpen = false;
    function start() {
      input.value = "";
      while (main.lastElementChild) {
        main.lastElementChild.remove();
      }
      keywordsFound = [];
      startMenu.classList.add("gone");
      input.focus();

      startTimestamp = new Date();
      new Message("center", startTimestamp.getFullYear()+"년 "+(startTimestamp.getMonth()+1)+"월 "+startTimestamp.getDate()+"일", "date");

      chatOpen = true;
      setTimeout(read_data, 1000);
    }
  </script>
</html>
