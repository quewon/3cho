<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>채팅방</title>
    <style media="screen">
      @import url('https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css');
      @import url('https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css');
.spoka * { font-family: 'Spoqa Han Sans', 'Spoqa Han Sans JP', 'Sans-serif'; }

      :root {
        --red: #d14141;
      }

      body, html {
        margin: 0;
        overflow: hidden;
        font-size: 30px;
        font-family: 'Spoqa Han Sans', sans-serif;
        /* font-smooth: never;
        -webkit-font-smoothing: none;
        -moz-osx-font-smoothing: grayscale; */
        background: var(--red);
      }

      body {
        width: 100vw;
        height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      main {
        width: 100vw;
        flex-grow: 1;
        overflow-x: hidden;
        overflow-y: scroll;

        display: flex;
        flex-direction: column-reverse;
        align-items: baseline;
        gap: .5em;
        padding: .5em;
        box-sizing: border-box;
        background: white;
      }
      a {
        color: var(--red);
        cursor: pointer;
      }
      a.found {
        color: gray;
      }

      .response {
        animation: popup 400ms;
        transform-origin: left;
        display: flex;
        gap: .25rem;
      }
      @keyframes popup {
        0% {
          max-height: 0;
          scale: .8 1;
          margin-bottom: 0;
          opacity: 0;
        }
        50% {
          margin-bottom: 10px;
          opacity: 1;
        }
        100% {
          max-height: 100%;
          scale: 1 1;
          margin-bottom: 0;
        }
      }
      .response .icon {
        width: 1.5em;
        height: 1.5em;
        border-radius: 50%;
        background: lightgray;
        aspect-ratio: 1;
      }
      .response .content {
        padding: .5em;
        background: lightgray;
        border-radius: 1em;
      }

      /* .response.left.first .content {
        border-top-left-radius: 0;
      }
      .response.right.first .content {
        border-top-right-radius: 0;
      } */

      .response.right {
        align-self: end;
        transform-origin: right;
      }
      .response.right .icon {
        display: none;
      }
      .response.right .content, .response.player .content {
        background: var(--red);
        color: white;
      }
      .response.right a, .response.player a {
        background: white;
      }
      .response.right:has(a) .content, .response.player:has(a) .content {
        background: white;
        border: 1px solid var(--red);
        box-sizing: border-box;
        color: black;
      }
      .response.player .icon {
        background: var(--red);
      }

      .response.date {
        font-size: .8em;
        color: white;
        opacity: .8;
        align-self: center;
        animation: none;
        color: black;
      }
      .response.date .icon {
        display: none;
      }

      #inputContainer {
        width: calc(100vw - .5em);
        height: 2rem;
        display: flex;
        justify-content: space-between;
        /* border: 1px solid black; */
        border-radius: 1em;
        margin: .25em;
        background: white;
        overflow: hidden;
        flex-shrink: 0;
      }
      #inputContainer button {
        /* border: 1px solid black; */
        background: var(--red);
        color: white;
        border-radius: 50%;
        width: var(--input-height);
        margin: .15rem;
        aspect-ratio: 1;
      }

      input {
        width: 100vw;
        font-family: inherit;
        font-size: inherit;
        padding: .5em;
        margin: 0;
        outline: none;
        border: none;
        background: transparent;
      }
      input:disabled {
        background: lightgray;
      }
      input:disabled::placeholder {
        text-align: center;
      }
      #inputContainer:has(input:disabled) {
        background: lightgray;
      }

      header {
        color: white;
        padding: .5rem;
        text-align: center;
      }

      .gone {
        display: none;
      }

      #start-menu {
        width: 100vw;
        height: 101dvh;
        background: var(--red);
        color: white;
        position: absolute;
        top: 0;
        left: 0;
        font-size: 18px;
      }
      #start-menu > div {
        top: 50%;
        left: 50%;
        position: absolute;
        translate: -50% -50%;
        width: 100%;
        text-align: center;
      }
      button {
        background: transparent;
        border: none;
        color: black;
        padding: .5em;
        padding-top: 0em;
        padding-bottom: 0em;
        font-size: inherit;
        font-family: inherit;
      }
      button:hover {
        cursor: pointer;
        opacity: .9
      }
      button:active {
        background: black;
        color: white;
      }

      #start-menu button, header button {
        border: 1px solid white;
        color: white;
        margin-bottom: .25rem;
      }
      #start-menu button:active, header button:active {
        background: white;
        color: var(--red);
      }
      #start-menu button.checked {
        background: white;
        color: var(--red);
        pointer-events: none;
      }

      #pause-button {
        position: absolute;
        top: .5rem;
        left: .5rem;
        font-size: 18px;
        margin: 0;
        background-image: url("res/house.svg");
        width: 1rem;
        height: 1rem;
      }
    </style>
  </head>
  <body>

    <header>
      <b>[17세기 소년을 죽이는 법]</b>
      <button id="pause-button" onclick="restart()">
      </button>
    </header>

    <main>

    </main>

    <div id="inputContainer">
      <input type="text" autofocus placeholder="키워드를 쳐보세요" />
      <button onclick="sendMessage()">></button>
    </div>

    <div id="start-menu">
      <div>
        <b>[17세기 소년을 죽이는 법]</b>
        <br><br>
        <button onclick="changeMode('normal');checkButton(this.nextElementSibling.nextElementSibling, this)" class="checked">기본 모드</button><br>
        <button onclick="changeMode('easy');checkButton(this.previousElementSibling.previousElementSibling, this)">쉬운 모드</button>
        <br><br>
        <button onclick="start()">시작</button>
      </div>
    </div>

    <template id="template-텍스트">

    </template>

  </body>
  <script defer type="text/javascript">
    const API_KEY = "AIzaSyCF5muJe5QsZnMSwjmFzofH5b3Ay-GgccY";
    const SHEET_ID = "1bIV3VUzn55cLkD-dxWoOkbt4NrA0V4OdYP_TGijlL2I";
    var BANK = {};

    function load_bank(onload) {
      function SheetArrayToObject(array) {
        if (array == undefined) return undefined;

        const keys = array[0];
        const output = [];

        for (let row=1; row<array.length; row++) {
          var entry = {};
          var inputArray = array[row][0].split(",");

          if (array[row].length==1) continue;

          for (let inputKey of inputArray) {
            output[inputKey] = {
              messages: array[row][1].split("\n"),
              rowId: row,
              color: array[row].length <= 2 ? true : array[row][2],
              isHelp: row==2
            };
          }
        }

        return output;
      }

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/output/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        BANK = SheetArrayToObject(data.values);
        if (onload) onload();
      });
    }

    const startMenu = document.getElementById("start-menu");
    const main = document.querySelector("main");
    const input = document.querySelector("input");
    const userColors = [
      "#348feb",
      "#dea937"
    ];
    var currentUserColor = 0;

    function receiveMessage(response) {
      var element = document.createElement("div");
      element.classList.add("response");
      element.classList.add(response["형식"]);
      element.textContent = response["출력"];
      main.appendChild(element);
    }

    var keywordsFound;
    const delay = ms => new Promise(res => setTimeout(res, ms));
    async function sendMessage() {
      if (input.disabled) return;

      const message = input.value.trim();
      if (message == "") return;

      new Message("right", message);
      write_data(message);

      input.value = "";

      await playResponses(message);
    }

    async function playResponses(message) {
      input.blur();
      input.disabled = true;
      input.placeholder = "...";

      var messages = [];
      var hasHelp = false;
      var helpId = null;
      var hasNonHelp = false;

      var matchedMessageArrays = {};

      //TODO: make messages appear in order that keywords are typed
      for (let key in BANK) {
        if (message.includes(key)) {
          matchedMessageArrays[BANK[key].rowId] = BANK[key].messages;
          if (BANK[key].isHelp) {
            hasHelp = true;
            helpId = BANK[key].rowId;
          } else {
            hasNonHelp = true;
          }
        }
      }

      if (hasHelp && hasNonHelp) {
        matchedMessageArrays[helpId].delete();
      }

      const matchedIds = Object.keys(matchedMessageArrays);
      if (matchedIds.length > 0) {
        const firstMessage = matchedMessageArrays[matchedIds[0]][0];
        await delay(firstMessage.replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 50);
      }

      for (let i=0; i<matchedIds.length; i++) {
        currentUserColor++;
        if (currentUserColor >= userColors.length) currentUserColor = 0;
        const color = userColors[currentUserColor];

        const arr = matchedMessageArrays[matchedIds[i]];

        for (let j=0; j<arr.length; j++) {
          var text = arr[j];
          var name = "";
          if (text.includes(": ")) {
            const a = text.split(": ");
            name = a[0];
            text = a[1];
          }
          new Message("left", text, null, color, name);
          if (j<arr.length-1 || i<matchedIds.length-1) {
            await delay(text.replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 70);
          }
        }
      }

      input.placeholder = "키워드를 쳐보세요";
      input.disabled = false;
      input.focus();
    }

    class Message {
      constructor(position, text, type, iconColor, name) {
        var element = document.createElement("div");
        element.classList.add("response");
        if (type) element.classList.add(type);
        element.classList.add(position);

        var icon = document.createElement("div");
        icon.classList.add("icon");
        element.classList.add("first");
        if (iconColor) icon.style.background = iconColor;
        if (name) {
          element.name = name;
          const prevElementName = main.firstElementChild.name;
          if (prevElementName == name) {
            icon.style.background = "transparent";
            element.classList.remove("first");
          }
        }
        if (position == "right" && main.firstElementChild.classList.contains("right")) {
          element.classList.remove("first");
        }
        element.appendChild(icon);

        var content = document.createElement("div");
        content.classList.add("content");
        element.appendChild(content);

        if (easyMode) {
          for (let key in BANK) {
            if (BANK[key].color == "FALSE") continue;
            text = text.replaceAll(key, "<a class='"+(keywordsFound.includes(key) ? "found" : "")+"' onclick=input.value='"+key+"';input.focus()>"+key+"</a>")
          }
        }
        content.innerHTML = text;

        this.element = element;

        main.prepend(this.element);
      }
    }

    load_bank(function() {
      input.addEventListener("keyup", function(e) {
        if (e.key == "Enter") {
          sendMessage();
        }
      });
      restart();
    });

    function read_data() {
      const timestamp = new Date().getTime();

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/history/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        if (chatOpen || easyMode) setTimeout(read_data, 2000);

        if (input.disabled) return;

        for (let i=1; i<data.values.length; i++) {
          const messageTimestamp = data.values[i][0];
          const messageContent = data.values[i][1];

          if (
            messageTimestamp >= startTimestamp &&
            (
              !loggedMessages[messageTimestamp] || loggedMessages[messageTimestamp] != messageContent
            )
          ) {
            loggedMessages[messageTimestamp] = messageContent;
            new Message("left", messageContent, "player");
            playResponses(messageContent);
          }
        }
      });
    }

    function write_data(text) {
      const timestamp = new Date().getTime();
      const data = new FormData();
      data.set("timestamp", timestamp);
      data.set("text", text);

      loggedMessages[timestamp] = text;

      fetch("https://script.google.com/macros/s/AKfycbzYX6v5YFLqdMqhaAt61C6epn6emf5SY2YFU4_ILEJv3EiRmsjPo_NbfJ4Qdt4yAI3G/exec", {
        method: "POST",
        body: data
      })
      .then(function(e) {
        console.log("success")
      })
      .catch(function(e) {
        console.log("** error **\n"+e);
      });
    }

    var startTimestamp;
    var loggedMessages;
    var chatOpen;
    var easyMode;

    function restart() {
      loggedMessages = {}
      chatOpen = false;
      easyMode = false;
      input.blur();
      startMenu.classList.remove("gone");
    }

    function changeMode(mode) {
      if (mode == "easy") {
        easyMode = true;
      } else {
        easyMode = false;
      }
    }
    function checkButton(removeChecked, addChecked) {
      removeChecked.classList.remove("checked");
      addChecked.classList.add("checked");
    }

    function start() {
      input.value = "";
      while (main.lastElementChild) {
        main.lastElementChild.remove();
      }
      keywordsFound = [];
      startMenu.classList.add("gone");
      input.focus();

      startTimestamp = new Date();
      new Message("center", startTimestamp.getFullYear()+"년 "+(startTimestamp.getMonth()+1)+"월 "+startTimestamp.getDate()+"일", "date");

      chatOpen = true;
      setTimeout(read_data, 1000);
    }
  </script>
</html>
