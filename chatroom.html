<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>채팅방</title>
    <style media="screen">
      @import url('https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css');
      @import url('https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css');
.spoka * { font-family: 'Spoqa Han Sans', 'Spoqa Han Sans JP', 'Sans-serif'; }

      :root {
        --red: #d14141;
      }

      body, html {
        margin: 0;
        overflow: hidden;
        font-size: 25px;
        font-family: 'Spoqa Han Sans', sans-serif;
        /* font-smooth: never;
        -webkit-font-smoothing: none;
        -moz-osx-font-smoothing: grayscale; */
        background: var(--red);
      }

      body {
        width: 100vw;
        height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      main {
        width: 100vw;
        flex-grow: 1;
        overflow-x: hidden;
        overflow-y: scroll;

        display: flex;
        flex-direction: column-reverse;
        align-items: baseline;
        gap: .5em;
        padding: .5em;
        box-sizing: border-box;
        background: white;

        border-top-left-radius: 2rem;
        border-top-right-radius: 2rem;
      }
      a {
        color: var(--red);
        cursor: pointer;
      }
      a.found {
        color: gray;
      }

      .response {
        animation: popup 400ms;
        transform-origin: left;
        display: flex;
        position: relative;
      }
      .response.left.first::before {
        content: attr(data-name);
        position: absolute;
        top: 0;
        left: 2rem;
        font-size: 24px;
        white-space: nowrap;
      }
      @keyframes popup {
        0% {
          max-height: 0;
          scale: .8 1;
          margin-bottom: 0;
          opacity: 0;
        }
        50% {
          margin-bottom: 10px;
          opacity: 1;
        }
        100% {
          max-height: 100%;
          scale: 1 1;
          margin-bottom: 0;
        }
      }
      .response .icon {
        width: 1.5em;
        height: 1.5em;
        border-radius: 50%;
        background: lightgray;
        aspect-ratio: 1;
        align-self: end;
        translate: 0 50%;

        opacity: 0;
      }
      .response.last .icon {
        opacity: 1;
      }
      .response.left:first-child {
        padding-bottom: .75rem;
      }
      .response .content {
        padding: .5em;
        background: lightgray;
        border-radius: 1em;
        margin-left: .25rem;
        margin-right: .25rem;
      }
      .response.left.last .content {
        border-bottom-left-radius: 0;
      }
      .response.left.first .content {
        margin-top: 1.5rem;
      }
      .timestamp {
        position: absolute;
        right: 0;
        bottom: 0;
        font-size: .7em;
        translate: 100% 0;
        white-space: nowrap;
        width: max-content;
      }
      .response.right .timestamp {
        left: 0;
        translate: -100% 0;
      }
      .like {
        position: absolute;
        right: 0;
        top: 50%;
        translate: 0 -50%;
        opacity: 0;
      }
      .response.right .like {
        left: 0;
      }
      .response:hover .like {
        opacity: .5;
      }
      .like.checked {
        opacity: 1 !important;
      }
      .like:active {
        opacity: 1 !important;
        background: transparent;
      }

      .response.right {
        align-self: end;
        transform-origin: right;
        flex-direction: row-reverse;
      }
      .response.right .icon {
        display: none;
      }
      .response.right .content {
        background: var(--red);
        color: white;
      }
      .response.right.last {
        border-bottom-right-radius: 0;
      }
      .response.right a, .response.player a {
        background: white;
      }
      .response.right:has(a) .content, .response.player:has(a) .content {
        background: white;
        border: 1px solid var(--red);
        box-sizing: border-box;
        color: black;
      }
      .response.player .icon {
        background: var(--red);
      }

      .response.date {
        font-size: .8em;
        align-self: center;
        animation: none;
        color: white;
      }
      .response.date .content {
        background: gray;
      }
      .response.date .icon, .response.date .like, .response.date .timestamp {
        display: none;
      }

      #input-container {
        background: white;
        border-top: 1px solid lightgray;
        padding: .5rem;
        padding-left: 2rem;
        padding-right: 2rem;
      }
      #input-wrapper {
        height: 2.5rem;
        display: flex;
        justify-content: space-between;
        border-radius: 2rem;
        overflow: hidden;
        flex-shrink: 0;
        background: lightgray;
      }
      #input-wrapper button {
        /* border: 1px solid black; */
        background: var(--red);
        color: white;
        border-radius: 50%;
        aspect-ratio: 1;
        margin-right: 1rem;

        width: 1.5rem;
        height: 1.5rem;
        align-self: center;
      }

      #scroll-icon {
        position: absolute;
        bottom: 4rem;
        left: 50%;
        translate: -50% 0;
        width: 1.5rem;
        height: 1.5rem;
        background: var(--red);
        border-radius: 50%;
        cursor: pointer;
        text-align: center;
        color: white;
      }

      input {
        width: 100vw;
        font-family: inherit;
        font-size: inherit;
        padding: 1rem;
        margin: 0;
        outline: none;
        border: none;
        background: transparent;
      }
      input:disabled {
        background: lightgray;
      }
      input:disabled::placeholder {
        text-align: center;
      }
      #input-wrapper:has(input:disabled) {
        background: lightgray;
      }

      header {
        color: white;
        padding: .5rem;
        text-align: center;
      }

      .gone {
        display: none;
      }

      #start-menu {
        width: 100vw;
        height: 101dvh;
        background: var(--red);
        color: white;
        position: absolute;
        top: 0;
        left: 0;
        font-size: 18px;
      }
      #start-menu > div {
        top: 50%;
        left: 50%;
        position: absolute;
        translate: -50% -50%;
        width: 100%;
        text-align: center;
      }
      button {
        background: transparent;
        border: none;
        color: black;
        padding: .5em;
        padding-top: 0em;
        padding-bottom: 0em;
        font-size: inherit;
        font-family: inherit;
      }
      button:hover {
        cursor: pointer;
        opacity: .9
      }
      button:active {
        background: black;
        color: white;
      }

      #start-menu button, header button {
        border: 1px solid white;
        color: white;
        margin-bottom: .25rem;
      }
      #start-menu button:active, header button:active {
        background: white;
        color: var(--red);
      }
      #start-menu button.checked {
        background: white;
        color: var(--red);
        pointer-events: none;
      }

      #pause-button {
        position: absolute;
        top: .5rem;
        left: .5rem;
        margin: 0;
        background-image: url("res/house.svg");
        width: 1rem;
        height: 1rem;
      }
    </style>
  </head>
  <body>

    <header>
      17세기 소년을 죽이는 법
      <button id="pause-button" onclick="restart()">
      </button>
    </header>

    <main>

    </main>

    <div id="input-container">
      <div id="input-wrapper">
        <input type="text" autofocus placeholder="키워드를 쳐보세요" />
        <button onclick="sendMessage()">></button>
      </div>
    </div>

    <div id="scroll-icon">↓</div>

    <div id="start-menu">
      <div>
        <b>[17세기 소년을 죽이는 법]</b>
        <br><br>
        <button onclick="changeMode('normal');checkButton(this.nextElementSibling.nextElementSibling, this)" class="checked">기본 모드</button><br>
        <button onclick="changeMode('easy');checkButton(this.previousElementSibling.previousElementSibling, this)">쉬운 모드</button>
        <br><br>
        <div id="mode-desc"></div>
        <br>
        <button onclick="start()">시작</button>
      </div>
    </div>

    <template id="template-텍스트">

    </template>

  </body>
  <script defer type="text/javascript">
    // data

    const API_KEY = "AIzaSyCF5muJe5QsZnMSwjmFzofH5b3Ay-GgccY";
    const SHEET_ID = "1bIV3VUzn55cLkD-dxWoOkbt4NrA0V4OdYP_TGijlL2I";
    var BANK = {};
    var USERNAMES = {};
    const HELP_ID = 2;

    function load_bank(onload) {
      function SheetArrayToObject(array) {
        if (array == undefined) return undefined;

        const keys = array[0];
        const output = [];

        for (let row=1; row<array.length; row++) {
          var entry = {};
          if (array[row].length == 0) continue;
          var inputArray = array[row][0].split(",");

          if (array[row].length==1) continue;

          for (let inputKey of inputArray) {
            output[inputKey.replaceAll(" ","")] = {
              messages: array[row][1].split("\n"),
              rowId: row,
              color: array[row].length <= 2 ? true : array[row][2] == "TRUE",
              isHelp: row==HELP_ID,
              showOnce: array[row].length <= 3 ? false : array[row][3] == "TRUE",
            };
          }
        }

        return output;
      }

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/output/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        BANK = SheetArrayToObject(data.values);
        if (onload) onload();
      })
      .catch((e) => {
        console.log(e);
        load_bank(onload);
      });
    }

    function load_usernames(onload) {
      function SheetArrayToObject(array) {
        if (array == undefined) return undefined;

        const keys = array[0];
        const output = [];

        for (let col=0; col<keys.length; col++) {
          const key = keys[col];
          output[key] = [];
          for (let row=1; row<array.length; row++) {
            const value = array[row][col];
            if (!value || value.trim() == "") continue;
            output[key].push(value);
          }
        }

        return output;
      }

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/usernames/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        USERNAMES = SheetArrayToObject(data.values);
        if (onload) onload();
      })
      .catch((e) => {
        console.log(e);
        load_usernames(onload);
      });
    }

    // dom stuff

    const SCROLL_BASELINE = 0;

    const startMenu = document.getElementById("start-menu");
    const main = document.querySelector("main");
    const input = document.querySelector("input");
    const scrollDownIcon = document.getElementById("scroll-icon");
    const modeDesc = document.getElementById("mode-desc");

    main.addEventListener("scroll", function(e) {
      if (main.scrollTop >= SCROLL_BASELINE) {
        scrollDownIcon.classList.add("gone");
      }
    });
    scrollDownIcon.onclick = function(e) {
      main.scrollTop = 0;
      this.classList.add("gone");
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));
    async function sendMessage() {
      if (input.disabled) return;

      const message = input.value.trim();
      if (message == "") return;

      new Message(playerUsername, message, "right");
      if (!easyMode) write_data(message);

      input.value = "";
      main.scrollTop = 0;

      await playResponses(message);
    }

    async function playResponses(message) {
      message = message.replaceAll(" ","");

      input.blur();
      input.disabled = true;
      input.placeholder = "...";

      var messages = [];
      var hasHelp = false;
      var hasNonHelp = false;

      var matchedMessageArrays = {};

      //TODO: make messages appear in order that keywords are typed
      for (let key in BANK) {
        if (message.includes(key)) {
          if (BANK[key].showOnce && readResponses.indexOf(""+BANK[key].rowId) != -1) {
            continue;
          }

          matchedMessageArrays[BANK[key].rowId] = BANK[key].messages;
          if (BANK[key].isHelp) {
            hasHelp = true;
          } else {
            hasNonHelp = true;
          }
        }
      }

      if (hasHelp && hasNonHelp) {
        delete matchedMessageArrays[HELP_ID];
      }

      if (!chatOpen) return;

      const matchedIds = Object.keys(matchedMessageArrays);
      if (matchedIds.length > 0) {
        const firstMessage = matchedMessageArrays[matchedIds[0]][0];
        await delay(firstMessage.replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 50);
      }

      var assignedNames = {};

      for (let i=0; i<matchedIds.length; i++) {
        const id = matchedIds[i];
        const arr = matchedMessageArrays[id];

        readResponses.push(id);

        for (let j=0; j<arr.length; j++) {
          var text = arr[j];
          var name = "";
          if (text.includes(": ")) {
            const a = text.split(": ");
            name = a[0];
            text = a[1];
          }
          if (!assignedNames[name]) {
            var nameExists = true;
            while (nameExists) {
              assignedNames[name] = generateName();

              nameExists = false;
              for (let uniqueId in assignedNames) {
                if (uniqueId == name) continue;
                if (assignedNames[uniqueId] == assignedNames[name]) {
                  nameExists = true;
                }
              }
            }
          }
          new Message(assignedNames[name], text, "left");
          if (!chatOpen) return;
          if (j<arr.length-1 || i<matchedIds.length-1) {
            await delay(text.replaceAll("ㅋ","").replaceAll("?","").replaceAll(".","").length * 70);
          }
        }
      }

      input.placeholder = "키워드를 쳐보세요";
      input.disabled = false;
      input.focus();
    }

    class Message {
      constructor(name, text, position, type, time) {
        var element = document.createElement("div");
        element.classList.add("response");
        if (type) element.classList.add(type);
        element.classList.add(position);

        var icon = document.createElement("div");
        icon.classList.add("icon");
        element.classList.add("first");
        element.classList.add("last");
        element.appendChild(icon);
        if (name) {
          element.dataset.name = name;
          const prevElementName = main.firstElementChild.dataset.name;
          if (prevElementName == name) {
            main.firstElementChild.classList.remove("last");
            element.classList.remove("first");
          }
        }
        if (position == "right" && main.firstElementChild.classList.contains("right")) {
          main.firstElementChild.classList.remove("last");
          element.classList.remove("first");
        }

        var content = document.createElement("div");
        content.classList.add("content");
        element.appendChild(content);

        var like = document.createElement("button");
        like.textContent = "❤️";
        like.classList.add("like");
        like.onclick = function() {
          this.classList.toggle("checked");
        };
        element.appendChild(like);
        this.likeElement = like;

        if (easyMode) {
          for (let key in BANK) {
            if (!BANK[key].color) continue;

            var keywordFound = false;
            for (let id of readResponses) {
              if (BANK[key].rowId == id) {
                keywordFound = true;
                break;
              }
            }

            text = text.replaceAll(key, "<a class='"+(keywordFound ? "found" : "")+"' onclick=input.value='"+key+"';input.focus()>"+key+"</a>")
          }
        }
        content.innerHTML = text;

        time = time ? new Date(time) : new Date();
        var timeElement = document.createElement("div");
        timeElement.classList.add("timestamp");
        var hours = time.getHours();
        var minutes = time.getMinutes();
        timeElement.textContent = (hours >= 12 ? "오후" : "오전")+" "+(hours%12)+"시 "+minutes+"분";
        element.appendChild(timeElement);

        this.element = element;

        if (main.scrollTop < SCROLL_BASELINE) {
          scrollDownIcon.classList.remove("gone");
        }

        main.prepend(this.element);
      }
    }

    function read_data() {
      const timestamp = new Date().getTime();

      fetch("https://sheets.googleapis.com/v4/spreadsheets/"+SHEET_ID+"/values/history/?key="+API_KEY)
      .then((response) => response.json())
      .then((data) => {
        if (!chatOpen || easyMode) {
          return;
        } else {
          setTimeout(read_data, 2000);
        }

        if (input.disabled) return;

        if (!data.values) return;

        for (let i=1; i<data.values.length; i++) {
          const messageTimestamp = data.values[i][0];
          const messageContent = data.values[i][1];
          const messageName = data.values[i][2];

          if (
            messageTimestamp >= startTimestamp &&
            (
              !loggedMessages[messageTimestamp] || loggedMessages[messageTimestamp] != messageContent
            )
          ) {
            loggedMessages[messageTimestamp] = messageContent;
            new Message(messageName, messageContent, "left", "player", messageTimestamp);
            playResponses(messageContent);
          }
        }
      });
    }

    function write_data(text) {
      const timestamp = new Date().getTime();
      const data = new FormData();
      data.set("timestamp", timestamp);
      data.set("text", text);
      data.set("name", playerUsername);

      loggedMessages[timestamp] = text;

      fetch("https://script.google.com/macros/s/AKfycbxvLunYS6QD5hr4HwbVlD_fLsbhbSUjef6_wSLrv1NNRfJbFO5WTnIF18m3p0_aFQlH/exec", {
        method: "POST",
        body: data
      })
      .then(function(e) {
        console.log("success")
      })
      .catch(function(e) {
        console.log("** error **\n"+e);
      });
    }

    var startTimestamp;
    var loggedMessages;
    var chatOpen;
    var easyMode;
    var playerUsername;
    var readResponses;

    function restart() {
      loggedMessages = {}
      chatOpen = false;
      easyMode = false;
      input.blur();
      input.disabled = false;
      input.placeholder = "키워드를 쳐보세요";
      scrollDownIcon.classList.add("gone");
      changeMode("normal");
      checkButton(startMenu.querySelectorAll("button")[1], startMenu.querySelectorAll("button")[0]);
      startMenu.classList.remove("gone");
      playerUsername = generateName();
      readResponses = [];
    }

    function generateName() {
      const a = USERNAMES["형용사"][Math.random() * USERNAMES["형용사"].length | 0];
      const b = USERNAMES["명사"][Math.random() * USERNAMES["명사"].length | 0];
      return a+" "+b;
    }

    function changeMode(mode) {
      if (mode == "easy") {
        easyMode = true;
        modeDesc.innerHTML = "[쉬운 모드]<br>콘텐츠를 쉽게 접근할 수 있지만, 다른 관람자와 연동이 안됩니다.<br>기본 모드를 먼저 경험해본 관람자에게 추천합니다."
      } else {
        easyMode = false;
        modeDesc.innerHTML = "[기본 모드]<br>의도된 관람 방식입니다.";
      }
    }
    function checkButton(removeChecked, addChecked) {
      removeChecked.classList.remove("checked");
      addChecked.classList.add("checked");
    }

    function start() {
      input.value = "";
      while (main.lastElementChild) {
        main.lastElementChild.remove();
      }
      startMenu.classList.add("gone");
      input.focus();

      startTimestamp = new Date();
      new Message(null, startTimestamp.getFullYear()+"년 "+(startTimestamp.getMonth()+1)+"월 "+startTimestamp.getDate()+"일", "date", "center");

      chatOpen = true;
      setTimeout(read_data, 1000);
    }

    var _loadCount = 0;

    document.body.classList.add("gone");

    function init() {
      console.log("program loaded");

      document.body.classList.remove("gone");

      input.addEventListener("keyup", function(e) {
        if (e.key == "Enter") {
          sendMessage();
        }
      });
      restart();
    }

    load_usernames(function() {
      if (++_loadCount == 2) {
        init();
      }
    });

    load_bank(function() {
      if (++_loadCount == 2) {
        init();
      }
    });
  </script>
</html>
